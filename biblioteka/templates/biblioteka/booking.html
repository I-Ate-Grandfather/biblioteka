{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ö–§–£</title>
    <link rel="stylesheet" href="{% static 'biblioteka/css/styles.css' %}">
</head>
<body>

{% include "biblioteka/header.html" %}

<main class="container" style="padding:24px;">
    <h1>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ —á–∏—Ç–∞–ª—å–Ω–æ–º/–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–º –∑–∞–ª–µ</h1>

    <div class="booking-layout">

        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ -->
        <section class="booking-form">
            <h3>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ</h3>

            <form id="bookingForm">
                <!-- –§–∏–ª–∏–∞–ª (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π from view) -->
                <div class="form-group">
                    <label for="branch">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª *</label>
                    <select id="branch" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª</option>
                        {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –¢–∏–ø –∑–∞–ª–∞ -->
                <div class="form-group">
                    <label for="hall-type">–¢–∏–ø –∑–∞–ª–∞ *</label>
                    <select id="hall-type" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–ª–∞</option>
                        <option value="reading">–ß–∏—Ç–∞–ª—å–Ω—ã–π –∑–∞–ª</option>
                        <option value="computer">–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∑–∞–ª</option>
                    </select>
                </div>

                <!-- –î–∞—Ç–∞ -->
                <div class="form-group">
                    <label for="date">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É *</label>
                    <input type="date" id="date" class="form-input" required>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–æ–ª–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ -->
                <div id="availabilityInfo" class="availability-info">
                    <p class="placeholder-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª, —Ç–∏–ø –∑–∞–ª–∞ –∏ –¥–∞—Ç—É ‚Äî —Å–ø—Ä–∞–≤–∞ –ø–æ—è–≤—è—Ç—Å—è —Å–ª–æ—Ç—ã.</p>
                </div>

                <button type="submit" class="btn btn-primary">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ</button>
            </form>
        </section>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–ª–æ—Ç—ã -->
        <section class="availability-section">
            <h3>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Å—Ç</h3>

            <div id="time-slots" class="time-slots">
                <p class="placeholder-text">–°–ª–æ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞, —Ç–∏–ø–∞ –∑–∞–ª–∞ –∏ –¥–∞—Ç—ã.</p>
            </div>
        </section>
    </div>

    <!-- –ü—Ä–∞–≤–∏–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <section class="rules-section" style="margin-top: 18px;">
        <h3>–ü—Ä–∞–≤–∏–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div class="rules-grid" style="display:flex; gap:18px;">
            <div class="rules-column" style="flex:1;">
                <h4>üìù –£—Å–ª–æ–≤–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>
                <ul>
                    <li>‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 8 —á–∞—Å–æ–≤ –ø–æ–¥—Ä—è–¥</li>
                    <li>‚Ä¢ –û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 2 —á–∞—Å–∞</li>
                    <li>‚Ä¢ –ü—Ä–∏ –æ–ø–æ–∑–¥–∞–Ω–∏–∏ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 30 –º–∏–Ω—É—Ç –±—Ä–æ–Ω—å –∞–Ω–Ω—É–ª–∏—Ä—É–µ—Ç—Å—è</li>
                    <li>‚Ä¢ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –º–µ—Å—Ç–æ</li>
                </ul>
            </div>
            <div class="rules-column" style="flex:1;">
                <h4>‚ö†Ô∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                <ul>
                    <li>‚Ä¢ –ü—Ä–∏ —Å–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π –±–∏–ª–µ—Ç</li>
                    <li>‚Ä¢ –í —á–∏—Ç–∞–ª—å–Ω–æ–º –∑–∞–ª–µ –∑–∞–ø—Ä–µ—â–µ–Ω—ã —Ä–∞–∑–≥–æ–≤–æ—Ä—ã</li>
                    <li>‚Ä¢ –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ (–∫—Ä–æ–º–µ –≤–æ–¥—ã) –∑–∞–ø—Ä–µ—â–µ–Ω—ã</li>
                    <li>‚Ä¢ –ú–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –≤ –±–µ–∑–∑–≤—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ</li>
                </ul>
            </div>
        </div>
    </section>
</main>

{% include "biblioteka/footer.html" %}

<script>
(function(){
    const branchEl = document.getElementById('branch');
    const hallTypeEl = document.getElementById('hall-type');
    const dateEl = document.getElementById('date');
    const timeSlotsDiv = document.getElementById('time-slots');
    const availabilityInfo = document.getElementById('availabilityInfo');
    const form = document.getElementById('bookingForm');

    // –•—Ä–∞–Ω–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {room_id, start, end, element})
    let selectedSlots = [];

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –º–∞–∫—Å. —á–∞—Å–æ–≤ –ø–æ–¥—Ä—è–¥ (–∏–∑ –ø—Ä–∞–≤–∏–ª) ‚Äî 8
    const MAX_HOURS = 8;

    function formatSlotLabel(start, end, free) {
        return `${start} ‚Äî ${end} | –°–≤–æ–±–æ–¥–Ω–æ: ${free}`;
    }

    function clearSelectedUI() {
        selectedSlots.forEach(s => {
            if (s.element) s.element.classList.remove('selected');
        });
        selectedSlots = [];
        updateInfo();
    }

    function updateInfo() {
        if (selectedSlots.length === 0) {
            availabilityInfo.innerHTML = '<p class="placeholder-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç—ã —Å–ø—Ä–∞–≤–∞.</p>';
            return;
        }
        // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞—á–∞–ª—É
        const sorted = selectedSlots.slice().sort((a,b) => a.start.localeCompare(b.start));
        const roomName = sorted[0].room_name || '';
        const start = sorted[0].start;
        const last = sorted[sorted.length - 1];
        const end = last.end;
        availabilityInfo.innerHTML = `<p>–í—ã–±—Ä–∞–Ω–æ –≤ –∑–∞–ª–µ <strong>${roomName}</strong>: <strong>${start} ‚Äî ${end}</strong> (${selectedSlots.length} —á–∞—Å/–æ–≤)</p>`;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –µ–¥–∏–Ω–æ–≥–æ –∑–∞–ª–∞
    function validateAndSetSelection(newSlot) {
        // –¥–æ–±–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ
        // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî —É–¥–∞–ª—è–µ–º
        const idx = selectedSlots.findIndex(s => s.room_id === newSlot.room_id && s.start === newSlot.start);
        if (idx !== -1) {
            // —Å–Ω—è—Ç—å –≤—ã–±–æ—Ä
            const removed = selectedSlots.splice(idx,1)[0];
            if (removed.element) removed.element.classList.remove('selected');
            updateInfo();
            return;
        }

        // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ
        const tmp = selectedSlots.concat([newSlot]);

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –≤—Å–µ —Å–ª–æ—Ç—ã –±—ã–ª–∏ –æ–¥–Ω–æ–≥–æ room_id
        const roomSet = new Set(tmp.map(s => String(s.room_id)));
        if (roomSet.size > 1) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç—ã —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –∑–∞–ª–µ.');
            return;
        }

        // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ start
        tmp.sort((a,b) => a.start.localeCompare(b.start));

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (prev.end === curr.start)
        for (let i = 1; i < tmp.length; i++) {
            if (tmp[i-1].end !== tmp[i].start) {
                alert('–°–ª–æ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ (–±–µ–∑ —Ä–∞–∑—Ä—ã–≤–æ–≤).');
                return;
            }
        }

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if (tmp.length > MAX_HOURS) {
            alert(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî ${MAX_HOURS} —á–∞—Å–æ–≤.`);
            return;
        }

        // –û–ö ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º: —Å—Ç–∞–≤–∏–º –∫–ª–∞—Å—Å selected –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        selectedSlots.push(newSlot);
        if (newSlot.element) newSlot.element.classList.add('selected');

        // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        selectedSlots.sort((a,b) => a.start.localeCompare(b.start));
        updateInfo();
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º –∫–æ–º–Ω–∞—Ç—ã –∏ —Å–ª–æ—Ç—ã (–æ—Ç–≤–µ—Ç API: { rooms: [ {id, name, total_seats, slots:[{start,end,free}] } ] })
    function renderRooms(rooms) {
        timeSlotsDiv.innerHTML = '';
        clearSelectedUI();

        if (!rooms || rooms.length === 0) {
            timeSlotsDiv.innerHTML = '<p class="placeholder-text">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–ª–æ–≤/—Å–ª–æ—Ç–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.</p>';
            return;
        }

        rooms.forEach(room => {
            const roomBlock = document.createElement('div');
            roomBlock.className = 'room-block';

            const title = document.createElement('div');
            title.textContent = `${room.name} ‚Äî –≤—Å–µ–≥–æ –º–µ—Å—Ç: ${room.total_seats}`;
            title.style.fontWeight = '600';
            title.style.marginBottom = '8px';
            roomBlock.appendChild(title);

            const slotContainer = document.createElement('div');
            slotContainer.className = 'slot-container';

            room.slots.forEach(s => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'slot-btn';
                btn.textContent = formatSlotLabel(s.start, s.end, s.free);
                if (!s.free || s.free <= 0) btn.disabled = true;

                // –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                btn.dataset.roomId = room.id;
                btn.dataset.roomName = room.name;
                btn.dataset.start = s.start;
                btn.dataset.end = s.end;
                btn.dataset.free = s.free;

                // –∫–ª–∏–∫ ‚Äî –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä
                btn.addEventListener('click', function() {
                    const slotObj = {
                        room_id: this.dataset.roomId,
                        room_name: this.dataset.roomName,
                        start: this.dataset.start,
                        end: this.dataset.end,
                        element: this
                    };
                    validateAndSetSelection(slotObj);
                });

                slotContainer.appendChild(btn);
            });

            roomBlock.appendChild(slotContainer);
            timeSlotsDiv.appendChild(roomBlock);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å API
    function loadAvailability() {
        const branch = branchEl.value;
        const hall = hallTypeEl.value;
        const date = dateEl.value;

        clearSelectedUI();

        if (!branch || !hall || !date) {
            timeSlotsDiv.innerHTML = '<p class="placeholder-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª, —Ç–∏–ø –∑–∞–ª–∞ –∏ –¥–∞—Ç—É</p>';
            return;
        }

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        fetch(`/api/availability/?branch=${encodeURIComponent(branch)}&hall=${encodeURIComponent(hall)}&date=${encodeURIComponent(date)}`)
            .then(resp => {
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏');
                return resp.json();
            })
            .then(data => {
                // –æ–∂–∏–¥–∞–µ–º data.rooms (—Å–º–æ—Ç—Ä–∏ backend)
                renderRooms(data.rooms || []);
            })
            .catch(err => {
                timeSlotsDiv.innerHTML = `<p class="placeholder-text">–û—à–∏–±–∫–∞: ${err.message}</p>`;
            });
    }

    // –°–∞–±–º–∏—Ç —Ñ–æ—Ä–º—ã: —Å–æ–±–∏—Ä–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –∏–∑ selectedSlots –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    form.addEventListener('submit', function(e){
        e.preventDefault();

        if (selectedSlots.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç—ã —Å–ø—Ä–∞–≤–∞.');
            return;
        }

        // –≤—Å–µ —Å–ª–æ—Ç—ã –æ–¥–Ω–æ–≥–æ –∑–∞–ª–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –¥–µ–ª–∞–ª–∞—Å—å) -> –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π
        const sorted = selectedSlots.slice().sort((a,b) => a.start.localeCompare(b.start));
        const first = sorted[0];
        const last = sorted[sorted.length - 1];

        // –∑–∞—â–∏—Ç–∞: –Ω–µ –±–æ–ª—å—à–µ 8 —á–∞—Å–æ–≤
        if (sorted.length > MAX_HOURS) {
            alert(`–ù–µ–ª—å–∑—è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ ${MAX_HOURS} —á–∞—Å–æ–≤.`);
            return;
        }

        const payload = {
            room_id: first.room_id,
            date: dateEl.value,
            start: first.start,
            end: last.end,
            seats: 1
        };

        fetch('/api/book/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(resp => resp.json())
        .then(json => {
            if (json.success) {
                alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
                // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤
                clearSelectedUI();
                loadAvailability();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (json.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å'));
            }
        })
        .catch(err => {
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + err.message);
        });
    });

    // —Å–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    branchEl.addEventListener('change', loadAvailability);
    hallTypeEl.addEventListener('change', loadAvailability);
    dateEl.addEventListener('change', loadAvailability);

    // CSRF helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã (—Å–µ–≥–æ–¥–Ω—è)
    (function setMinDate(){
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        if (dateEl) dateEl.min = `${yyyy}-${mm}-${dd}`;
    })();

})();
</script>

</body>
</html>
