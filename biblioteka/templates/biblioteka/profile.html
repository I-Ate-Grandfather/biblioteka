{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Профиль - Библиотека КФУ</title>
    <link type="text/css" href="{% static 'biblioteka/css/styles.css' %}" rel="stylesheet">
</head>
<body>

{% include "biblioteka/header.html" %}

<main class="container">
    <h1>Личный кабинет</h1>

    <div class="profile-layout">
        <!-- Студенческий пропуск -->
        {% if user.is_authenticated %}
            <aside class="student-card">
                <div class="student-photo">
                    <div class="photo-placeholder">Фото</div>
                </div>

                <div class="student-info">
                    <!-- ФИО из модели User -->
                    <h2>{{ user.last_name }} {{ user.first_name }}</h2>

                    <div class="student-details">
                        <!-- Остальные данные из модели Profile -->
                        <p><strong>Читательский билет:</strong>
                            {% if profile.library_card %}
                                {{ profile.library_card }}
                            {% else %}
                                Не указан
                            {% endif %}
                        </p>

                        <p><strong>Группа:</strong>
                            {% if profile.student_group %}
                                {{ profile.student_group }}
                            {% else %}
                                Не указана
                            {% endif %}
                        </p>

                        <p><strong>Факультет:</strong>
                            {% if profile.faculty %}
                                {{ profile.faculty }}
                            {% else %}
                                Не указан
                            {% endif %}
                        </p>

                        <p><strong>Тип пользователя:</strong> {{ profile.get_user_type_display }}</p>
                    </div>

                    <div class="contact-info">
                        <!-- Email из модели User -->
                        <p><strong>Email:</strong>
                            {% if user.email %}
                                {{ user.email }}
                            {% else %}
                                Не указан
                            {% endif %}
                        </p>

                        <!-- Телефон из модели Profile -->
                        <p><strong>Телефон:</strong>
                            {% if profile.phone %}
                                {{ profile.phone }}
                            {% else %}
                                Не указан
                            {% endif %}
                        </p>
                    </div>
                </div>
            </aside>
        {% else %}
            <p>Пользователь не аутентифицирован</p>
        {% endif %}
        <!-- История книг -->
            <section class="books-history">
                <h3>История книг</h3>

                <div class="items-list" id="loans-container">
                    {% for loan in book_loans %}
                    <div class="item-card {{ loan.status }}" id="loan-{{ loan.id }}">
                        <div class="item-info">
                            <h4>{{ loan.book_copy.book.title }}</h4>
                            <p>Автор: {{ loan.book_copy.book.get_authors_display }}</p>
                            <p>Филиал: {{ loan.book_copy.branch.name }}</p>
                            {% if loan.book_copy.book.price %}
                            <p>Стоимость: {{ loan.book_copy.book.price }} руб.</p>
                            {% endif %}
                        </div>
                        <div class="item-dates">
                            <p><strong>Дата выдачи:</strong> {{ loan.issue_date|date:"d.m.Y" }}</p>
                            <p><strong>Срок возврата:</strong> {{ loan.due_date|date:"d.m.Y" }}</p>
                            {% if loan.return_date %}
                            <p><strong>Дата возврата:</strong> {{ loan.return_date|date:"d.m.Y" }}</p>
                            {% endif %}
                        </div>
                        <div class="item-status-actions">
                            <span class="status {{ loan.status }}">
                                {{ loan.get_status_display }}
                            </span>

                            <!-- ВАЖНО: Проверяем статус модели BookLoan, а не BookCopy! -->
                            {% if loan.status == 'active' %}
                                <button class="btn-lost" onclick="reportLostBook({{ loan.id }}, '{{ loan.book_copy.book.title|escapejs }}')">
                                    Книга утеряна
                                </button>
                            {% elif loan.status == 'overdue' %}
                                <button class="btn-lost" onclick="reportLostBook({{ loan.id }}, '{{ loan.book_copy.book.title|escapejs }}')">
                                    Книга утеряна
                                </button>
                            {% elif loan.status == 'lost' %}
                                <button class="btn-pay" onclick="payFine({{ loan.id }}, '{{ loan.book_copy.book.title|escapejs }}', {{ loan.book_copy.book.price|default:500 }})">
                                    Оплатить штраф
                                </button>
                            {% elif loan.status == 'fine_paid' %}
                                <span class="badge-paid">Штраф оплачен</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-books">
                        <p>У вас нет истории выданных книг</p>
                    </div>
                    {% endfor %}
                </div>
            </section>

        <!-- Забронированные книги -->
            <section class="booked-books">
                <h3>Забронированные книги</h3>

                <div class="items-list" id="booked-books-container">
                    {% for booking in book_bookings %}
                    <div class="item-card booked-item" id="booked-{{ booking.id }}">
                        <div class="item-info">
                            <h4>{{ booking.book_copy.book.title }}</h4>
                            <p>Автор: {{ booking.book_copy.book.get_authors_display }}</p>
                            <p>Филиал: {{ booking.branch.name }}</p>
                            <p><strong>Статус:</strong> {{ booking.get_status_display }}</p>
                            {% if booking.book_copy.book.price %}
                            <p>Стоимость: {{ booking.book_copy.book.price }} руб.</p>
                            {% endif %}
                        </div>
                        <div class="item-dates">
                            <p><strong>Дата бронирования:</strong> {{ booking.created_at|date:"d.m.Y H:i" }}</p>
                            {% if booking.pickup_deadline %}
                            <p><strong>Забрать до:</strong> {{ booking.pickup_deadline|date:"d.m.Y H:i" }}</p>
                            {% endif %}
                            {% if booking.ready_by %}
                            <p><strong>Готов к выдаче с:</strong> {{ booking.ready_by|date:"d.m.Y H:i" }}</p>
                            {% endif %}
                        </div>
                        <div class="item-status-actions">
                            <span class="status booking-status booking-{{ booking.status }}">
                                {{ booking.get_status_display }}
                            </span>

                            {% if booking.status == 'pending' or booking.status == 'ready' %}
                            <button class="btn-cancel-book" onclick="cancelBookBooking({{ booking.id }}, '{{ booking.book_copy.book.title|escapejs }}')">
                                Отменить бронь
                            </button>
                            {% elif booking.status == 'issued' %}
                            <span class="badge-issued">Выдано</span>
                            {% elif booking.status == 'cancelled' %}
                            <span class="badge-cancelled">Отменено</span>
                            {% elif booking.status == 'expired' %}
                            <span class="badge-expired">Просрочено</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-bookings">
                        <p>У вас нет забронированных книг</p>
                    </div>
                    {% endfor %}
                </div>
            </section>

        <!-- Бронирование читального зала -->
        <section class="reading-room-bookings">
            <h3>Бронирование читального зала</h3>

            <div class="items-list" id="bookings-container">
                {% for booking in room_bookings %}
                <div class="item-card" id="booking-{{ booking.id }}">
                    <div class="item-info">
                        <h4>{{ booking.room.name }}</h4>
                        <p><strong>Филиал:</strong> {{ booking.room.branch.name }}</p>
                        <p><strong>Адрес:</strong> {{ booking.room.branch.address }}</p>
                        {% if booking.room.has_computers %}
                        <p><strong>Оснащение:</strong> Компьютеры{% if booking.room.has_outlets %}, Розетки{% endif %}</p>
                        {% elif booking.room.has_outlets %}
                        <p><strong>Оснащение:</strong> Розетки</p>
                        {% endif %}
                    </div>
                    <div class="item-dates">
                        <p><strong>Дата:</strong> {{ booking.booking_date|date:"d.m.Y" }}</p>
                        <p><strong>Время:</strong> {{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}</p>
                        <p><strong>Количество мест:</strong> {{ booking.seats_count }}</p>
                    </div>
                    <div class="item-status-actions">
                        <span class="status confirmed">
                            Подтверждено
                        </span>

                        <!-- КНОПКА ОТМЕНЫ БРОНИРОВАНИЯ -->
                        <button class="btn-cancel" onclick="cancelBooking({{ booking.id }})">
                            Отменить
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="no-bookings">
                    <p>У вас нет активных бронирований</p>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>
</main>

{% include "biblioteka/footer.html" %}

<!-- Вставь этот код в profile.html перед закрывающим тегом </body> -->

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
// ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
let currentLoanId = null;
let currentFineId = null;
let paymentCheckInterval = null;

// ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function showMessage(text, type = 'info') {
    const msg = document.createElement('div');
    msg.className = 'message';
    msg.textContent = text;

    // Стили в зависимости от типа
    msg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#28a745' :
                     type === 'error' ? '#dc3545' :
                     type === 'info' ? '#17a2b8' : '#ffc107'};
        color: white;
        border-radius: 4px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;

    document.body.appendChild(msg);

    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
        msg.style.opacity = '0';
        msg.style.transition = 'opacity 0.5s';
        setTimeout(() => msg.remove(), 500);
    }, 3000);
}

function updateLoanStatus(loanId, newStatus, amount) {
    const loanCard = document.getElementById(`loan-${loanId}`);
    if (!loanCard) return;

    const statusSpan = loanCard.querySelector('.status');
    const actionsDiv = loanCard.querySelector('.item-status-actions');

    // Обновляем класс карточки
    loanCard.className = `item-card ${newStatus}`;

    if (newStatus === 'lost') {
        statusSpan.textContent = 'Утеряна';
        statusSpan.className = 'status lost';

        // Показываем кнопку оплаты
        actionsDiv.innerHTML = `
            <span class="status lost">Утеряна</span>
            <button class="btn-pay" onclick="payFine(${loanId}, '${loanCard.querySelector('h4').textContent}', ${amount})">
                Оплатить штраф
            </button>
        `;

    } else if (newStatus === 'fine_paid') {
        statusSpan.textContent = 'Штраф оплачен';
        statusSpan.className = 'status fine_paid';

        // Показываем бейдж
        actionsDiv.innerHTML = `
            <span class="status fine_paid">Штраф оплачен</span>
            <span class="badge-paid">Оплачено</span>
        `;
    }
}

function checkEmptyBookings() {
    const container = document.getElementById('bookings-container');
    const bookings = container.querySelectorAll('.item-card');
    if (bookings.length === 0) {
        container.innerHTML = '<div class="no-bookings"><p>У вас нет активных бронирований</p></div>';
    }
}

// ==================== ОТМЕНА БРОНИРОВАНИЯ ====================
function cancelBooking(bookingId) {
    if (!confirm('Отменить бронирование?')) return;

    const bookingCard = document.getElementById(`booking-${bookingId}`);
    if (bookingCard) {
        const btn = bookingCard.querySelector('.btn-cancel');
        btn.disabled = true;
        btn.textContent = 'Отменяется...';
        bookingCard.style.opacity = '0.7';
    }

    fetch(`/profile/cancel-booking/${bookingId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrfToken()}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (bookingCard) {
                bookingCard.style.opacity = '0';
                setTimeout(() => {
                    bookingCard.remove();
                    checkEmptyBookings();
                    showMessage('Бронирование отменено', 'success');
                }, 300);
            }
        } else {
            throw new Error(data.error || 'Ошибка отмены');
        }
    })
    .catch(error => {
        if (bookingCard) {
            const btn = bookingCard.querySelector('.btn-cancel');
            btn.disabled = false;
            btn.textContent = 'Отменить';
            bookingCard.style.opacity = '1';
        }
        showMessage('Ошибка при отмене бронирования', 'error');
    });
}

// ==================== ОТМЕНА БРОНИРОВАНИЯ КНИГИ ====================
function cancelBookBooking(bookingId, bookTitle) {
    if (!confirm(`Отменить бронирование книги "${bookTitle}"?`)) return;

    const bookingCard = document.getElementById(`booked-${bookingId}`);
    if (bookingCard) {
        const btn = bookingCard.querySelector('.btn-cancel-book');
        btn.disabled = true;
        btn.textContent = 'Отменяется...';
        bookingCard.style.opacity = '0.7';
    }

    fetch(`/books/booking/${bookingId}/cancel/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (bookingCard) {
                // Плавно скрываем и удаляем карточку
                bookingCard.style.opacity = '0';
                setTimeout(() => {
                    bookingCard.remove();
                    checkEmptyBookedBooks();
                    showMessage('Бронирование книги отменено', 'success');
                }, 300);
            }
        } else {
            throw new Error(data.error || 'Ошибка отмены');
        }
    })
    .catch(error => {
        if (bookingCard) {
            const btn = bookingCard.querySelector('.btn-cancel-book');
            btn.disabled = false;
            btn.textContent = 'Отменить бронь';
            bookingCard.style.opacity = '1';
        }
        showMessage('Ошибка при отмене бронирования книги', 'error');
    });
}

// Проверяем пустой ли список бронированных книг
function checkEmptyBookedBooks() {
    const container = document.getElementById('booked-books-container');
    const bookings = container.querySelectorAll('.booked-item');
    if (bookings.length === 0) {
        container.innerHTML = '<div class="no-bookings"><p>У вас нет забронированных книг</p></div>';
    }
}

// ==================== УТЕРЯ КНИГИ ====================
function reportLostBook(loanId, bookTitle) {
    if (!confirm(`Отметить книгу "${bookTitle}" как утерянную?`)) return;

    const loanCard = document.getElementById(`loan-${loanId}`);
    const btn = loanCard.querySelector('.btn-lost');
    btn.disabled = true;
    btn.textContent = 'Обработка...';

    fetch(`/loans/${loanId}/mark-lost/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrfToken()}
    })
    .then(response => response.json())
    .then(data => {
        console.log('Ответ от mark-lost:', data);

        if (data.success) {
            // Обновляем интерфейс
            updateLoanStatus(loanId, 'lost', data.book_price);
            showMessage('Книга помечена как утерянная', 'info');
        } else {
            throw new Error(data.error || 'Ошибка');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.textContent = 'Книга утеряна';
        showMessage('Ошибка при пометке книги как утерянной', 'error');
    });
}

// ==================== ОПЛАТА ШТРАФА ====================
function payFine(loanId, bookTitle, amount) {
    if (!confirm(`Оплатить штраф ${amount} руб за книгу "${bookTitle}"?`)) return;

    currentLoanId = loanId;
    const loanCard = document.getElementById(`loan-${loanId}`);
    const btn = loanCard.querySelector('.btn-pay');
    btn.disabled = true;
    btn.textContent = 'Создание платежа...';

    console.log(`Создание платежа для loanId: ${loanId}`);

    fetch(`/loans/${loanId}/pay-fine/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ошибка: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Полный ответ от сервера:', data);

        if (data.success) {
            // Проверяем что fine_id получен
            if (!data.fine_id) {
                console.error('Ошибка: fine_id не получен от сервера');
                throw new Error('ID штрафа не получен');
            }

            currentFineId = data.fine_id;
            console.log(`Платеж создан. fine_id: ${data.fine_id}, payment_id: ${data.payment_id}`);

            // Открываем страницу оплаты
            const paymentWindow = window.open(
                data.payment_url,
                '_blank',
                'width=600,height=700'
            );

            // Начинаем проверку статуса
            startPaymentCheck(paymentWindow, loanId, data.fine_id);

            showMessage('Страница оплаты открыта. Не закрывайте её до завершения.', 'info');

        } else {
            throw new Error(data.error || 'Неизвестная ошибка');
        }
    })
    .catch(error => {
        console.error('Ошибка создания платежа:', error);
        btn.disabled = false;
        btn.textContent = 'Оплатить штраф';
        showMessage(`Ошибка: ${error.message}`, 'error');
    });
}

// ==================== ПРОВЕРКА СТАТУСА ОПЛАТЫ ====================
function startPaymentCheck(paymentWindow, loanId, fineId) {
    console.log(`Начинаем проверку статуса для fineId: ${fineId}`);

    // Останавливаем предыдущую проверку
    if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
    }

    let checkCount = 0;
    const maxChecks = 300; // 300 проверок * 2 секунды = 10 минут

    // Проверяем каждые 2 секунды
    paymentCheckInterval = setInterval(() => {
        checkCount++;

        if (checkCount > maxChecks) {
            clearInterval(paymentCheckInterval);
            showMessage('Время ожидания оплаты истекло', 'warning');
            return;
        }

        console.log(`Проверка ${checkCount} для fineId: ${fineId}`);

        fetch(`/fines/${fineId}/status/`)
            .then(response => {
                if (!response.ok) {
                    console.error(`HTTP ошибка при проверке статуса: ${response.status}`);
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Статус fine ${fineId}:`, data);

                if (data.paid) {
                    // Оплата успешна
                    clearInterval(paymentCheckInterval);

                    // Обновляем статус книги
                    updateLoanStatus(loanId, 'fine_paid');

                    // Закрываем окно оплаты если открыто
                    if (paymentWindow && !paymentWindow.closed) {
                        paymentWindow.close();
                    }

                    showMessage(`✅ Штраф оплачен! ${data.paid_at ? 'Дата: ' + data.paid_at : ''}`, 'success');

                    // Сбрасываем переменные
                    currentFineId = null;
                    currentLoanId = null;

                } else if (data.status === 'cancelled') {
                    // Платеж отменен
                    clearInterval(paymentCheckInterval);
                    showMessage('Платеж отменен', 'warning');
                    currentFineId = null;

                    // Восстанавливаем кнопку
                    const loanCard = document.getElementById(`loan-${loanId}`);
                    if (loanCard) {
                        const btn = loanCard.querySelector('.btn-pay');
                        if (btn) {
                            btn.disabled = false;
                            btn.textContent = 'Оплатить штраф';
                        }
                    }
                }

                // Для отладки: если прошло 20 секунд (10 проверок), показываем статус
                if (checkCount === 10) {
                    console.log('Промежуточный статус:', data.status);
                }
            })
            .catch(error => {
                console.error('Ошибка проверки статуса:', error);

                // Если много ошибок подряд, останавливаем проверку
                if (checkCount > 30) { // Через минуту
                    clearInterval(paymentCheckInterval);
                    showMessage('Проблемы с проверкой статуса оплаты', 'warning');
                }
            });
    }, 2000);

    // Также проверяем при возвращении на страницу (если пользователь вернулся)
    const checkOnFocus = () => {
        if (fineId) {
            fetch(`/fines/${fineId}/status/`)
                .then(response => response.json())
                .then(data => {
                    if (data.paid) {
                        updateLoanStatus(loanId, 'fine_paid');
                        showMessage('Штраф оплачен!', 'success');
                        window.removeEventListener('focus', checkOnFocus);
                    }
                });
        }
    };

    window.addEventListener('focus', checkOnFocus);
}

// ==================== ОЧИСТКА ПРИ ЗАКРЫТИИ СТРАНИЦЫ ====================
window.addEventListener('beforeunload', function() {
    if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
    }
});

// ==================== ТЕСТОВАЯ ФУНКЦИЯ (для разработки) ====================
// Добавь эту функцию если хочешь имитировать оплату для тестирования
function testPayment(fineId, loanId) {
    if (!confirm('Тест: Имитировать успешную оплату?')) return;

    fetch(`/fines/${fineId}/simulate-payment/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCsrfToken()}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateLoanStatus(loanId, 'fine_paid');
            showMessage('Тест: Штраф оплачен (имитация)', 'success');
        }
    })
    .catch(error => {
        console.error('Ошибка теста:', error);
        showMessage('Ошибка теста', 'error');
    });
}

// ==================== ИНИЦИАЛИЗАЦИЯ ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Страница профиля загружена');
    console.log('CSRF токен:', getCsrfToken());
});
</script>

<style>
/* Стили для кнопок */
.btn-lost {
    background-color: #ffc107;
    color: #000;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-lost:hover {
    background-color: #e0a800;
}

.btn-lost:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-pay {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-pay:hover {
    background-color: #c82333;
}

.btn-pay:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-cancel {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-cancel:hover {
    background-color: #545b62;
}

.btn-cancel:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Стили для статусов */
.status {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
}

.status.lost {
    background-color: #ffc107;
    color: #000;
}

.status.fine_paid {
    background-color: #28a745;
    color: white;
}

.status.confirmed {
    background-color: #d4edda;
    color: #155724;
}

/* Бейдж оплаты */
.badge-paid {
    background-color: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

/* Анимация удаления */
.item-card {
    transition: opacity 0.3s, transform 0.3s;
}

/* Стили для секций */
.item-status-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}
</style>
</body>
</html>