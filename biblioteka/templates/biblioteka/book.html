{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ book.title }} — Библиотека КФУ</title>
    <link type="text/css" href="{% static 'biblioteka/css/styles.css' %}" rel="stylesheet">
</head>
<body>

{% include "biblioteka/header.html" %}

<main class="container">
    <!-- Хлебные крошки -->
    <div class="breadcrumb">
        <a href="{% url 'main' %}">Главная</a> →
        <a href="{% url 'catalog' %}">Каталог книг</a> →
        <span>{{ book.title|truncatechars:15 }}</span>
    </div>

    <!-- Карточка книги -->
    <div class="book-detail">
        <!-- Обложка -->
        <div class="book-cover">
            {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
            {% else %}
                <img src="https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80" alt="{{ book.title }}">
            {% endif %}

            <div class="book-status">
                {% if available_copies > 0 %}
                    <span class="available">Доступно: {{ available_copies }} экз.</span>
                {% else %}
                    <span class="unavailable">Нет в наличии</span>
                {% endif %}
            </div>
        </div>

        <!-- Информация о книге -->
        <div class="book-info">
            <h1>{{ book.title }}</h1>

            <p><strong>Автор:</strong> {{ book.get_authors_display }}</p>

            {% if book.publication_year %}
            <p><strong>Год издания:</strong> {{ book.publication_year }}</p>
            {% endif %}

            <p><strong>Язык:</strong> {{ book.language }}</p>

            {% if book.pages %}
            <p><strong>Страниц:</strong> {{ book.pages }}</p>
            {% endif %}

            {% if book.price %}
            <p><strong>Цена:</strong> {{ book.price }} руб.</p>
            {% endif %}

            <!-- Описание -->
            {% if book.description %}
            <div class="description">
                <h3>Описание</h3>
                <p>{{ book.description }}</p>
            </div>
            {% endif %}

            <!-- Кнопка бронирования -->
            <div class="booking-section">
                {% if user.is_authenticated %}
                    {% if available_copies > 0 %}
                        {% if has_active_booking %}
                            <button class="btn-book" disabled style="background: #28a745;">
                                Уже забронировано
                            </button>
                            <p class="booking-note">Вы уже забронировали эту книгу</p>
                        {% else %}
                            <button class="btn-book" id="bookBtn">
                                Забронировать книгу
                            </button>
                            <p class="booking-note">Книга будет зарезервирована на 3 дня</p>
                        {% endif %}
                    {% else %}
                        <button class="btn-book" disabled>
                            Нет в наличии
                        </button>
                        <p class="booking-note">Нет доступных экземпляров</p>
                    {% endif %}
                {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn-book">
                        Войдите, чтобы забронировать
                    </a>
                    <p class="booking-note">Только для авторизованных пользователей</p>
                {% endif %}
            </div>
        </div>
    </div>
</main>

{% include "biblioteka/footer.html" %}

<input type="hidden" id="csrf_token" value="{{ csrf_token }}">

<script>
// Бронирование книги
document.getElementById('bookBtn')?.addEventListener('click', function() {
    if (!confirm('Забронировать эту книгу?')) {
        return;
    }

    const button = this;
    button.disabled = true;
    button.textContent = 'Бронируется...';

    fetch(`/books/{{ book.id }}/book/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.getElementById('csrf_token').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Книга успешно забронирована! Статус: "Готов к выдаче".');
            button.textContent = 'Забронировано';
            button.style.background = '#28a745';
            button.disabled = true;

            // Обновляем страницу через 2 секунды
            setTimeout(() => {
                window.location.reload();
            }, 2000);

        } else {
            alert(data.error || 'Ошибка бронирования');
            button.disabled = false;
            button.textContent = 'Забронировать книгу';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка сети');
        button.disabled = false;
        button.textContent = 'Забронировать книгу';
    });
});
</script>

<style>
.book-detail {
    display: flex;
    gap: 30px;
    margin: 20px 0;
    padding: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.book-cover {
    flex: 0 0 300px;
}

.book-cover img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 5px;
}

.book-status {
    margin-top: 10px;
    padding: 8px;
    text-align: center;
    border-radius: 3px;
}

.book-status .available {
    color: #155724;
    background: #d4edda;
    display: block;
    padding: 10px;
    font-size: 16px;
    font-weight: bold;
}

.book-status .unavailable {
    color: #721c24;
    background: #f8d7da;
    display: block;
    padding: 10px;
    font-size: 16px;
    font-weight: bold;
}

.book-info {
    flex: 1;
}

.book-info h1 {
    margin-top: 0;
    margin-bottom: 15px;
}

.book-info p {
    margin: 8px 0;
}

.description {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
}

.description h3 {
    margin-top: 0;
}

.booking-section {
    margin: 25px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 5px;
    text-align: center;
}

.btn-book {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    text-decoration: none;
    display: inline-block;
}

.btn-book:hover {
    background: #0056b3;
}

.btn-book:disabled {
    background: #6c757d;
    opacity: 0.6;
    cursor: not-allowed;
}

.booking-note {
    margin-top: 10px;
    color: #666;
    font-size: 14px;
}

@media (max-width: 768px) {
    .book-detail {
        flex-direction: column;
    }

    .book-cover {
        flex: none;
        max-width: 300px;
        margin: 0 auto;
    }
}
</style>
</body>
</html>